<!DOCTYPE html><html lang="zh-cn"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.15.9"><!-- Canonical URL --><link rel="canonical" href="https://blog.rogery.dev/post/faster-int-parse/"><!-- Webfonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer"><!-- Primary Meta Tags --><title>Roger Young | 快读优化：无符号整数解析的几种 trick</title><meta name="title" content="Roger Young | 快读优化：无符号整数解析的几种 trick"><meta name="description" content="学习性能分析的小作业。"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.rogery.dev/post/faster-int-parse/"><meta property="og:title" content="快读优化：无符号整数解析的几种 trick"><meta property="og:description" content="学习性能分析的小作业。"><meta property="og:image" content="https://files.rogery.dev/me/icon-128.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.rogery.dev/post/faster-int-parse/"><meta property="twitter:title" content="快读优化：无符号整数解析的几种 trick"><meta property="twitter:description" content="学习性能分析的小作业。"><meta property="twitter:image" content="https://files.rogery.dev/me/icon-128.png"><link rel="stylesheet" href="/_astro/about.6joxBN-J.css">
<style>.article{max-width:48rem;p{margin-top:1.5rem;margin-bottom:1.5rem;text-align:justify;font-size:1rem}a,a:visited{overflow-wrap:anywhere;--un-text-opacity:1;color:rgb(168 0 0 / var(--un-text-opacity));text-decoration:none}a:hover{text-decoration-line:underline}h1,h2,h3,h4{font-weight:700}h1{margin-top:2rem;margin-bottom:2rem;font-size:2rem}h2{margin-top:1.75rem;margin-bottom:1.75rem;font-size:1.75rem}h3{margin-top:1.5rem;margin-bottom:1.5rem;font-size:1.5rem}h4{margin-top:1.5rem;margin-bottom:1.5rem;font-size:1.25rem}h5{margin-top:1.5rem;margin-bottom:1.5rem;font-size:1rem}.katex-display{overflow-x:auto;overflow-y:hidden}img{display:block;max-width:100%;height:auto}ol,ul{list-style-type:disc;padding-left:2rem}input,button,textarea,select{font-family:inherit}textarea{width:100%}code,pre,kbd{font-family:Maple Mono,Jetbrains Mono}table{margin-left:auto;margin-right:auto;width:auto;border-collapse:collapse;overflow-x:scroll;counter-increment:caption}img{width:100%;height:auto}table>thead{border-top-width:2.27px;border-bottom-width:1.8px;--un-border-opacity:1;border-color:rgb(0 0 0 / var(--un-border-opacity));border-style:solid;border-left-style:none;border-right-style:none}table>tbody{border-bottom-width:2.27px;--un-border-opacity:1;border-color:rgb(0 0 0 / var(--un-border-opacity));border-style:solid;border-left-style:none;border-right-style:none;border-top-style:none}th,td{padding:.25rem 1rem}caption{text-align:left;font-size:.923em;padding:0 .25em .25em;width:100%;margin-left:0}caption:before{content:"Table " counter(caption) ". ";font-weight:700}blockquote{margin-left:0;margin-right:0;margin-top:1.5rem;margin-bottom:1.5rem;padding:.25rem 1.25rem;background-color:#eee;border-inline-start:5px solid #000}.scroll-wrapper{overflow-x:auto}.scroll-wrapper>table td{white-space:nowrap}nav ol{counter-reset:item}nav li{display:block}nav li:before{content:counters(item,".") " ";counter-increment:item;padding-right:.85rem;font-weight:inherit;color:var(--link-visited)}dl dd{text-align:center}pre{margin-top:1rem;margin-bottom:1rem;border-width:2px;--un-border-opacity:1;border-color:rgb(0 0 0 / var(--un-border-opacity));border-style:solid;padding:1rem}code{font-size:.875rem}}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}html,body{margin:0;padding:0;height:100%;scroll-behavior:smooth;line-height:1.5}a{color:inherit;text-decoration:inherit}button{background:none;border:none}ol,ul,menu{list-style:none;margin:0;padding:0}:where(html){line-height:1.15;-webkit-text-size-adjust:100%;text-size-adjust:100%}:where(h1){font-size:2em;margin-block-end:.67em;margin-block-start:.67em}:where(dl,ol,ul) :where(dl,ol,ul){margin-block-end:0;margin-block-start:0}:where(hr){box-sizing:content-box;color:inherit;height:0}:where(abbr[title]){text-decoration:underline;text-decoration:underline dotted}:where(b,strong){font-weight:bolder}:where(code,kbd,pre,samp){font-family:monospace,monospace;font-size:1em}:where(small){font-size:80%}:where(table){border-color:currentColor;text-indent:0}:where(button,input,select){margin:0}:where(button){text-transform:none}:where(button,input:is([type=button i],[type=reset i],[type=submit i])){-webkit-appearance:button}:where(progress){vertical-align:baseline}:where(select){text-transform:none}:where(textarea){margin:0}:where(input[type=search i]){-webkit-appearance:textfield;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}:where(button,input:is([type=button i],[type=color i],[type=reset i],[type=submit i]))::-moz-focus-inner{border-style:none;padding:0}:where(button,input:is([type=button i],[type=color i],[type=reset i],[type=submit i]))::-moz-focusring{outline:1px dotted ButtonText}:where(:-moz-ui-invalid){box-shadow:none}:where(dialog){background-color:#fff;border:solid;color:#000;height:-moz-fit-content;height:fit-content;left:0;margin:auto;padding:1em;position:absolute;right:0;width:-moz-fit-content;width:fit-content}:where(dialog:not([open])){display:none}:where(summary){display:list-item}@font-face{font-family:Maple Mono;font-style:normal;font-weight:400;src:local("Maple Mono"),url(https://fastly.jsdelivr.net/gh/subframe7536/maple-font/woff2/MapleMono-Regular.woff2),}
</style></head> <body class="flex flex-col font-serif dark:bg-base line-height-normal"> <header class="shadow print:hidden"> <nav class="max-w-6xl mx-auto"> <div class="flex items-center justify-between "> <div class="pl-2 flex items-center space-x-4"> <img src="https://files.rogery.dev/me/icon-128.png" alt="Roger's avatar" class="w-11 h-11 rounded-full border-solid border-2 border-stone-300 transition transition-duration-500 hover:transform-rotate-720"> <a class="decoration-none color-base color-initial font-bold" href="/">Roger Young</a> </div> <div class="sm:hidden"> <button class="p-4 text-6 justify-center hover:bg-stone-200 inline-flex items-center "> <span class="i-ph-list">xx</span> </button> </div> <nav class="hidden sm:block"> <ul> <a href="/" class="p-4 font-medium  hover:bg-stone-200 decoration-none color-initial" data-astro-cid-eimmu3lg> Home </a>  <a href="/post" class="p-4 font-medium  hover:bg-stone-200 decoration-none color-initial" data-astro-cid-eimmu3lg> Articles </a>  <a href="/about" class="p-4 font-medium  hover:bg-stone-200 decoration-none color-initial" data-astro-cid-eimmu3lg> About </a>  </ul> </nav> </div> </nav> </header> <main class="flex-1 px-4">  <article class="py-20"> <div class="article mx-auto">  <div class="text-center pt-10 pb-20"> <h1>快读优化：无符号整数解析的几种 trick</h1> <time datetime="2024-02-16T00:00:00.000Z"> 2024 年 2 月 16 日 </time> </div>  <p>代码仓库：<a href="https://github.com/rogeryoungh/bench-int-parse/tree/main">github/bench-int-parse</a>。</p>
<blockquote>
<p>学习性能分析的小作业。</p>
</blockquote>
<p>即 OIer/ACMer 常说的快读。本文测试了一种另类且易于实现的快读，结果表明快 50% 左右。</p>
<p>在开始之前，我对问题做以下约束：</p>
<ul>
<li>输入是类似 <code>0 123\n456 123456789</code> 的字符串，仅包含 ascii 字符</li>
<li>数字的范围是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><msup><mn>0</mn><mn>18</mn></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 10^{18}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">18</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> ，不考虑 <code>u64</code> 边界</li>
<li>实际中一般只有单个间隔符，但也要能够正确处理多个间隔符</li>
<li>在 O2 或者 O3 优化等级下进行测试</li>
<li>依据输入的性质，特化两种算法：
<ul>
<li>严格：输入是 ascii 字符</li>
<li>非严格（TODO）：仅有数字字符的值大于 <code>0x30</code></li>
</ul>
</li>
</ul>
<p>接下来我将做几种实现，并使用 <code>nanobench</code> 库来进行性能测试。</p>
<h2 id="一号选手isdigit">一号选手：isdigit</h2>
<p>最常见的快读往往使用 <code>isdigit</code> 或者等价的 <code>'0' &#x3C;= c &#x26;&#x26; c &#x3C;= '9'</code> 来进行实现。</p>
<p>常见的快读长这样：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49">inline</span><span style="color:#D73A49"> static</span><span style="color:#6F42C1"> u64</span><span style="color:#6F42C1"> isd_0_getu</span><span style="color:#24292E">(</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> char</span><span style="color:#D73A49"> *&#x26;</span><span style="color:#E36209">p</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  char</span><span style="color:#24292E"> c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#6F42C1">std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">isdigit</span><span style="color:#24292E">(c))</span></span>
<span class="line"><span style="color:#24292E">    c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  u64 x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> c </span><span style="color:#D73A49">-</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  for</span><span style="color:#24292E"> (c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">; </span><span style="color:#6F42C1">std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">isdigit</span><span style="color:#24292E">(c); c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 10</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> c </span><span style="color:#D73A49">-</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> x;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p>接下来对单间隔符，瞎写了种优化：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49">inline</span><span style="color:#D73A49"> static</span><span style="color:#6F42C1"> u64</span><span style="color:#6F42C1"> isd_1_getu</span><span style="color:#24292E">(</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> char</span><span style="color:#D73A49"> *&#x26;</span><span style="color:#E36209">p</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (</span><span style="color:#005CC5">true</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    char</span><span style="color:#24292E"> c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">isdigit</span><span style="color:#24292E">(c)) {</span></span>
<span class="line"><span style="color:#24292E">      u64 x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> c </span><span style="color:#D73A49">-</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      for</span><span style="color:#24292E"> (c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">; </span><span style="color:#6F42C1">std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">isdigit</span><span style="color:#24292E">(c); c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">        x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 10</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> c </span><span style="color:#D73A49">-</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      return</span><span style="color:#24292E"> x;</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p>江湖上还流传一些“优化”，我也尝试实现了其中部分：</p>
<ul>
<li><code>isd-0</code> ：上文中的 <code>isdigit_0_getu</code></li>
<li><code>isd-1</code> ：上文中的 <code>isdigit_1_getu</code></li>
<li><code>isd-u8</code> ：用 <code>u8</code> 存 <code>char</code></li>
<li><code>isd-m10</code>：把乘 10 写成 <code>(c &#x3C;&#x3C; 3) + (c &#x3C;&#x3C; 1)</code></li>
<li><code>isd-and</code>：把 <code>c - '0'</code> 写成 <code>c &#x26; 0xf</code></li>
<li><code>isd-xor</code>：把 <code>c - '0'</code> 写成 <code>c ^ '0'</code></li>
<li><code>isd-range</code>：把 <code>isdigit</code> 写成 <code>'0' &#x3C;= c &#x26;&#x26; c &#x3C;= '9'</code></li>
<li><code>isd-sub</code>：把 <code>isdigit</code> 写成 <code>u8(c - '0') &#x3C;= 9</code>，后面还可以省一次减法</li>
<li><code>isd-goto</code>：不用循环，用 <code>goto</code> 来书写逻辑。</li>
<li><code>isd-sub-1</code>：把上面跑得快的实现杂交一下</li>
<li><code>isd-sub-2</code>：循环展开 20 次</li>
</ul>
<h3 id="性能测试">性能测试</h3>
<p>具体的测试方法见后文，这里只展示在 <code>gcc -O2</code> 下的结果（单位 us）。</p>


























































































































<table><thead><tr><th>算法/长度</th><th>1</th><th>2</th><th>4</th><th>8</th><th>12</th><th>16</th></tr></thead><tbody><tr><td>isd-0</td><td>1057</td><td>1757</td><td>3145</td><td>6086</td><td>8854</td><td>11569</td></tr><tr><td>isd-1</td><td>1056</td><td>1638</td><td>3029</td><td>5917</td><td>8715</td><td>11452</td></tr><tr><td>isd-u8</td><td>881</td><td>1322</td><td>2627</td><td>4948</td><td>7863</td><td>10403</td></tr><tr><td>isd-m10</td><td>881</td><td>1322</td><td>2628</td><td>4963</td><td>7885</td><td>10404</td></tr><tr><td>isd-and</td><td>924</td><td>1322</td><td>2633</td><td>5151</td><td>7942</td><td>10271</td></tr><tr><td>isd-xor</td><td>1057</td><td>1499</td><td>3715</td><td>5630</td><td>8356</td><td>11253</td></tr><tr><td>isd-range</td><td>881</td><td>1371</td><td>2393</td><td>4853</td><td>7162</td><td>9851</td></tr><tr><td>isd-range-1</td><td>793</td><td>1295</td><td>2360</td><td>4811</td><td>7720</td><td>9978</td></tr><tr><td>isd-sub</td><td>793</td><td>1410</td><td>2637</td><td>5145</td><td>7831</td><td>10637</td></tr><tr><td>isd-goto</td><td>801</td><td>1453</td><td>2652</td><td>4749</td><td>8107</td><td>10639</td></tr><tr><td>isd-sub-1</td><td>793</td><td>1293</td><td>2389</td><td>4768</td><td>7842</td><td>9791</td></tr><tr><td>isd-sub-2</td><td>797</td><td>1321</td><td>2194</td><td>4198</td><td>6567</td><td>8923</td></tr></tbody></table>
<p>据此，我们可以得到一些结论：</p>
<ul>
<li>性能基本相近，短数字略有差距</li>
<li><code>isd-m10</code> 与 <code>isd-u8</code> 生成的汇编完全相同
<ul>
<li><code>lea</code> 指令非常强大，能够完成加乘混合计算，比如 <code>x * 10 + c - '0'</code> 仅需两条指令</li>
</ul>
</li>
<li><code>isd-xor</code> 异或可能会让性能略降</li>
<li><code>isd-range</code> 编译器把范围判断优化成减法判断，且减法使用 <code>lea</code> 而不是 <code>sub</code>，性能有神秘提升</li>
<li><code>isd-sub</code> 看似优化了一次减法，但是 <code>movzbl</code> 只加载到 <code>eax</code>，仍需要一条指令扩充至 64 位，在本地 <code>and</code> 莫名更快</li>
</ul>
<p>接下来仅保留部分作为代表继续参与测试。</p>
<h2 id="二号选手swarsimd-within-a-register">二号选手：SWAR（SIMD within a Register）</h2>
<p>举个例子，字符串 <code>"42"</code> 读取为 <code>u16</code> 是 <code>0x3234</code>（默认小端），即 <code>0x0204</code>。我们需要一个类似 <code>(x &#x3C;&#x3C; 8) * 10 + x</code> 的操作让高位与低位正确的合并。</p>
<p>整理一下就是乘以 <code>0x0a01</code>。即 <code>0x0204 * 0x0a01 = 0x142a04</code>，目标值 <code>0x2a = 42</code> 就在其中。类似的，我们可以设计实现 <code>u32</code> 或 <code>u64</code> 乃至更长的合并。</p>
<p>推荐阅读：<a href="https://kholdstare.github.io/technical/2020/05/26/faster-integer-parsing.html">Faster Integer Parsing</a>，图很直观。</p>
<h3 id="不足长">不足长</h3>
<p>对于不足长的字符串，我们还得再想想办法。</p>
<ul>
<li>合法的数字仅在 <code>0x30</code> 到 <code>0x39</code> 之间，因此仅有数字 <code>y = x &#x26; (x + 6)</code> 仍以 <code>0x30</code> 开头；</li>
<li>再经过 <code>z = (y &#x26; 0xf0f0) ^ 0x3030</code>，把数字位归零；</li>
<li>借助于位运算魔法，<code>len = std::countl_zero(z) >> 3</code>；</li>
<li>最后使用 <code>u = x >> (16 - (len &#x3C;&#x3C; 3))</code>，把数字对齐。</li>
</ul>
<p>另外，<code>std::countl_zero</code> 比 <code>ctz</code> 指令多了特判 0，编译器会为此优化生成快速路径，性能数据会在此跳跃。此处我选择了手工处理。</p>
<p>总之，我们可以比较容易的对 16、32、64 字长进行实现。这里仅展示 <code>u64</code> 实现。</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49">inline</span><span style="color:#D73A49"> static</span><span style="color:#6F42C1"> u64</span><span style="color:#6F42C1"> _swar_64</span><span style="color:#24292E">(</span><span style="color:#6F42C1">u64</span><span style="color:#E36209"> u</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  u </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (u </span><span style="color:#D73A49">&#x26;</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">0f0f0f0f0f0f0f0f</span><span style="color:#24292E">) </span><span style="color:#D73A49">*</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">0a01</span><span style="color:#D73A49"> >></span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">08</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  u </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (u </span><span style="color:#D73A49">&#x26;</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">00ff00ff00ff00ff</span><span style="color:#24292E">) </span><span style="color:#D73A49">*</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">00640001</span><span style="color:#D73A49"> >></span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">10</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  u </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (u </span><span style="color:#D73A49">&#x26;</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">0000ffff0000ffff</span><span style="color:#24292E">) </span><span style="color:#D73A49">*</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">271000000001</span><span style="color:#D73A49"> >></span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">20</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> u;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">inline</span><span style="color:#D73A49"> static</span><span style="color:#6F42C1"> u64</span><span style="color:#6F42C1"> swar_64_getu</span><span style="color:#24292E">(</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> char</span><span style="color:#D73A49"> *&#x26;</span><span style="color:#E36209">p</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  u64 x </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">u8</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">p </span><span style="color:#D73A49">-</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">) </span><span style="color:#D73A49">></span><span style="color:#005CC5"> 9</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    p</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  constexpr</span><span style="color:#24292E"> u32 p10[] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span><span style="color:#005CC5">1</span><span style="color:#24292E">, </span><span style="color:#005CC5">10</span><span style="color:#24292E">, </span><span style="color:#005CC5">100</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">, </span><span style="color:#005CC5">10000</span><span style="color:#24292E">, </span><span style="color:#005CC5">100000</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000000</span><span style="color:#24292E">, </span><span style="color:#005CC5">10000000</span><span style="color:#24292E">, </span><span style="color:#005CC5">100000000</span><span style="color:#24292E">};</span></span>
<span class="line"><span style="color:#D73A49">  constexpr</span><span style="color:#24292E"> u64 cx30 </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">3030303030303030</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (</span><span style="color:#005CC5">true</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    u64 u </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *reinterpret_cast&#x3C;const</span><span style="color:#24292E"> u64 </span><span style="color:#D73A49">*></span><span style="color:#24292E">(p);</span></span>
<span class="line"><span style="color:#24292E">    u64 umask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> u </span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E"> (u </span><span style="color:#D73A49">+</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">0606060606060606</span><span style="color:#24292E">) </span><span style="color:#D73A49">&#x26;</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">f0f0f0f0f0f0f0f0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (umask </span><span style="color:#D73A49">==</span><span style="color:#24292E"> cx30) {</span></span>
<span class="line"><span style="color:#24292E">      p </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">      x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> p10[</span><span style="color:#005CC5">8</span><span style="color:#24292E">] </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> _swar_64</span><span style="color:#24292E">(u);</span></span>
<span class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">      u64 len </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">countr_zero</span><span style="color:#24292E">(umask </span><span style="color:#D73A49">^</span><span style="color:#24292E"> cx30) </span><span style="color:#D73A49">>></span><span style="color:#005CC5"> 3</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      if</span><span style="color:#24292E"> (len </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">        u </span><span style="color:#D73A49">&#x3C;&#x3C;=</span><span style="color:#005CC5"> 64</span><span style="color:#D73A49"> -</span><span style="color:#24292E"> (len </span><span style="color:#D73A49">&#x3C;&#x3C;</span><span style="color:#005CC5"> 3</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">        p </span><span style="color:#D73A49">+=</span><span style="color:#24292E"> len;</span></span>
<span class="line"><span style="color:#24292E">        x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> p10[len] </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> _swar_64</span><span style="color:#24292E">(u);</span></span>
<span class="line"><span style="color:#24292E">      }</span></span>
<span class="line"><span style="color:#D73A49">      break</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"><span style="color:#24292E">  p</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> x;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p>我也尝试使用 AVX2 指令集进行实现，但是因为乘法位数不够，上述操作很难向量化，我的简陋实现的性能表现非常差，就不放出来丢脸了。</p>
<h2 id="三号选手打表">三号选手：打表</h2>
<p>比性能怎么少得了打表呢！</p>
<p>预处理一个字符串 <code>u16</code> 到数值的表即可，再对边界情况判断一下。</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49">template</span><span style="color:#24292E"> &#x3C;</span><span style="color:#D73A49">class</span><span style="color:#6F42C1"> T</span><span style="color:#24292E">></span></span>
<span class="line"><span style="color:#6F42C1">T</span><span style="color:#D73A49"> *</span><span style="color:#6F42C1">_prepare_16_table</span><span style="color:#24292E">() {</span></span>
<span class="line"><span style="color:#D73A49">  constexpr</span><span style="color:#24292E"> u32 N </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">10000</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  T </span><span style="color:#D73A49">*</span><span style="color:#24292E">f </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> new</span><span style="color:#24292E"> T[N];</span></span>
<span class="line"><span style="color:#6F42C1">  std</span><span style="color:#24292E">::</span><span style="color:#6F42C1">memset</span><span style="color:#24292E">(f, </span><span style="color:#D73A49">-</span><span style="color:#005CC5">1</span><span style="color:#24292E">, N);</span></span>
<span class="line"><span style="color:#D73A49">  for</span><span style="color:#24292E"> (u32 i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">!=</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">100</span><span style="color:#24292E">; </span><span style="color:#D73A49">++</span><span style="color:#24292E">i) {</span></span>
<span class="line"><span style="color:#D73A49">    for</span><span style="color:#24292E"> (u32 j </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; j </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 10</span><span style="color:#24292E">; </span><span style="color:#D73A49">++</span><span style="color:#24292E">j) {</span></span>
<span class="line"><span style="color:#24292E">      u32 t </span><span style="color:#D73A49">=</span><span style="color:#24292E"> i </span><span style="color:#D73A49">*</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">100</span><span style="color:#D73A49"> |</span><span style="color:#24292E"> j </span><span style="color:#D73A49">|</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">30</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      if</span><span style="color:#24292E"> (</span><span style="color:#032F62">'0'</span><span style="color:#D73A49"> &#x3C;=</span><span style="color:#24292E"> i </span><span style="color:#D73A49">&#x26;&#x26;</span><span style="color:#24292E"> i </span><span style="color:#D73A49">&#x3C;=</span><span style="color:#032F62"> '9'</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">        f[t] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> j </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 10</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> i </span><span style="color:#D73A49">-</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">30</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      else</span></span>
<span class="line"><span style="color:#24292E">        f[t] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> j </span><span style="color:#D73A49">|</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">100</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> f;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">inline</span><span style="color:#6F42C1"> u64</span><span style="color:#6F42C1"> pre_16_getu</span><span style="color:#24292E">(</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> char</span><span style="color:#D73A49"> *&#x26;</span><span style="color:#E36209">p</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  static</span><span style="color:#D73A49"> const</span><span style="color:#D73A49"> auto</span><span style="color:#D73A49"> *</span><span style="color:#24292E">pre16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> _prepare_16_table</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">u16</span><span style="color:#24292E">>();</span></span>
<span class="line"><span style="color:#24292E">  u8 c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#D73A49"> -</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (c </span><span style="color:#D73A49">></span><span style="color:#005CC5"> 9</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    c </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">p</span><span style="color:#D73A49">++</span><span style="color:#D73A49"> -</span><span style="color:#032F62"> '0'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  u64 x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> c;</span></span>
<span class="line"><span style="color:#D73A49">  while</span><span style="color:#24292E"> (</span><span style="color:#005CC5">true</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    u16 t </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *reinterpret_cast&#x3C;const</span><span style="color:#24292E"> u16 </span><span style="color:#D73A49">*></span><span style="color:#24292E">(p);</span></span>
<span class="line"><span style="color:#D73A49">    auto</span><span style="color:#24292E"> ft </span><span style="color:#D73A49">=</span><span style="color:#24292E"> pre16[t];</span></span>
<span class="line"><span style="color:#24292E">    p </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (ft </span><span style="color:#D73A49">&#x3C;</span><span style="color:#005CC5"> 100</span><span style="color:#24292E">) {</span><span style="color:#6A737D"> // len = 2</span></span>
<span class="line"><span style="color:#24292E">      x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 100</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> ft;</span></span>
<span class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span><span style="color:#6A737D"> // len = 1</span></span>
<span class="line"><span style="color:#D73A49">      if</span><span style="color:#24292E"> (ft </span><span style="color:#D73A49">&#x3C;</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">1000</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">        x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 10</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> ft </span><span style="color:#D73A49">-</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">100</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">      else</span></span>
<span class="line"><span style="color:#D73A49">        --</span><span style="color:#24292E">p;</span></span>
<span class="line"><span style="color:#D73A49">      break</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> x;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<h2 id="性能分析">性能分析</h2>
<p>测试方法：解析包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>20</mn></msup></mrow><annotation encoding="application/x-tex">2^{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span></span></span></span></span></span></span></span> 个数字的字符串，禁止循环展开（nounroll）。</p>
<p><img  src="/_astro/parse-int-swar-perf.D5oLlyEN_Z2rL5i0.webp" alt="性能表现" width="1680" height="1260" loading="lazy" decoding="async"></p>
<p>我们可以分析出以下结论：</p>
<ul>
<li>以 <code>isd-0</code> 为基准，<code>sub-2</code> 的效率约为 122%，还是有一定的性能提升的。</li>
<li><code>swar</code> 系在长数字情形下表现下十分优秀，例如 <code>swar-64</code> 效率可达 159%，在 len = 16 处更是高达 250%，但是 len = 1 处仅有 21%，短数字开销过大。</li>
<li><code>pre-16</code> 有更好的常数，中长数字下的效率约为 152%。</li>
</ul>
<p>总之，我选择 <code>pre-16</code> 作为最终实现。</p>
<h2 id="后记">后记</h2>
<p>代码仓库：<a href="https://github.com/rogeryoungh/bench-int-parse/tree/main">github/bench-int-parse</a>。</p>
<p>某天对 NTT 日常卡常时，突然怀疑起读入的效率。为此查了几篇资料，终有此文。</p>
<p>还有一些无暇琢磨的瞎想：</p>
<ul>
<li>或许可以把 <code>sub-2</code> 与 <code>pre-16</code> 再杂交一下；</li>
<li>可以一次读取 <code>u64</code>，用位运算模拟读取 <code>u16</code>、<code>u32</code>，可能比每次读取快；</li>
<li>可以测试一下循环展开下的性能，编译器可以对更好的排布指令，得到更低的延时；</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://kholdstare.github.io/technical/2020/05/26/faster-integer-parsing.html">Faster Integer Parsing</a></li>
<li><a href="https://weedge.github.io/post/simd/faster_integer_parsing/">译：更快的字符串转整数</a></li>
<li><a href="http://0x80.pl/articles/simd-parsing-int-sequences.html">Parsing series of integers with SIMD</a></li>
<li><a href="https://lemire.me/blog/2023/11/28/parsing-8-bit-integers-quickly/">Parsing 8-bit integers quickly</a></li>
</ul>  <section class="mx-auto mt-12"> <script src="https://giscus.app/client.js" data-repo="rogeryoungh/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzODQyNDIyNTQ=" data-category="Giscus" data-category-id="DIC_kwDOFucSTs4CTTLS" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script> </section>  </div> </article>  </main> <footer class="bg-stone-100 "> <div class="px-4 py-8"> <p class="flex items-center text-3 justify-center text-secondary"> <span>© 2024 Roger Young</span> <span class="i-ph-lightning px-1"></span> <span>Powered by
<a href="https://astro.build/">Astro</a> </span> </p> </div> </footer> </body></html>